generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider  = "postgresql"
}

// ============================================
// User Management
// ============================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  image         String?
  emailVerified DateTime?

  // GitHub Ïó∞Îèô
  githubId      Int?      @unique
  githubToken   String?   @db.Text

  // Relations
  accounts      Account[]
  sessions      Session[]
  repositories  Repository[]
  comments      Comment[]
  notifications Notification[]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([email])
  @@index([githubId])
}

// NextAuth ÌÖåÏù¥Î∏îÎì§
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ============================================
// GitHub Integration
// ============================================

model Repository {
  id           String    @id @default(cuid())
  githubId     Int       @unique
  name         String
  fullName     String    // "username/repo-name"
  description  String?
  language     String?
  isActive     Boolean   @default(true)
  webhookId    Int?      // GitHub Webhook ID

  // Relations
  owner        User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId       String
  pullRequests PullRequest[]

  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([userId])
  @@index([fullName])
}

model PullRequest {
  id          String    @id @default(cuid())
  githubId    Int       @unique
  number      Int
  title       String
  description String?   @db.Text
  status      PRStatus  @default(OPEN)

  // PR Î©îÌÉÄÎç∞Ïù¥ÌÑ∞
  baseBranch  String
  headBranch  String
  additions   Int       @default(0)
  deletions   Int       @default(0)
  changedFiles Int      @default(0)

  // Relations
  repo        Repository @relation(fields: [repoId], references: [id], onDelete: Cascade)
  repoId      String
  reviews     Review[]
  comments    Comment[]

  mergedAt    DateTime?
  closedAt    DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([repoId])
  @@index([status])
}

enum PRStatus {
  OPEN
  CLOSED
  MERGED
  DRAFT
}

// ============================================
// Code Review & AI
// ============================================

model Review {
  id              String       @id @default(cuid())

  // AI Î∂ÑÏÑù Í≤∞Í≥º
  aiSuggestions   Json         // AIÍ∞Ä Ï†úÏïàÌïú ÎÇ¥Ïö©Îì§
  qualityScore    Int          // 0-100 Ï†êÏàò
  severity        Severity     @default(LOW)
  issueCount      Int          @default(0)
  status          ReviewStatus @default(PENDING)

  // Relations
  pullRequest     PullRequest  @relation(fields: [pullRequestId], references: [id], onDelete: Cascade)
  pullRequestId   String

  reviewedAt      DateTime     @default(now())

  @@index([pullRequestId])
  @@index([status])
}

enum Severity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum ReviewStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
}

// ============================================
// Comments & Collaboration
// ============================================

model Comment {
  id              String    @id @default(cuid())
  content         String    @db.Text

  // ÏΩîÎìú ÏúÑÏπò
  lineNumber      Int?
  filePath        String?

  isResolved      Boolean   @default(false)

  // Relations
  pullRequest     PullRequest @relation(fields: [pullRequestId], references: [id], onDelete: Cascade)
  pullRequestId   String
  author          User        @relation(fields: [authorId], references: [id], onDelete: Cascade)
  authorId        String

  // ÎãµÍ∏Ä Í∏∞Îä• (Self-reference)
  parentId        String?
  parent          Comment?    @relation("CommentThread", fields: [parentId], references: [id], onDelete: Cascade)
  replies         Comment[]   @relation("CommentThread")

  // Î©òÏÖò & Î∞òÏùë
  mentions        String[]    // User IDs
  reactions       Json?       // {üëç: ['userId1'], ‚ù§Ô∏è: ['userId2']}

  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@index([pullRequestId])
  @@index([authorId])
}

model Notification {
  id        String           @id @default(cuid())
  type      NotificationType
  title     String
  message   String?
  isRead    Boolean          @default(false)

  // Relations
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String

  // Í¥ÄÎ†® ÏóîÌã∞Ìã∞
  prId      String?
  commentId String?

  createdAt DateTime         @default(now())

  @@index([userId, isRead])
}

enum NotificationType {
  MENTION
  NEW_REVIEW
  PR_MERGED
  COMMENT_REPLY
}
